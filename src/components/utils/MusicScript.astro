---
const { TRACKS } = Astro.props;
---

<script define:vars={{ TRACKS }}>
    const audio = document.getElementById("player");

    const titleEl = document.getElementById("trackTitle");
    const artistEl = document.getElementById("trackArtist");
    const coverEl = document.getElementById("diskImg");
    const playBtn = document.getElementById("playBtn");
    const playIcon = document.getElementById("playIcon");
    const nextBtn = document.getElementById("nextBtn");
    const progressEl = document.getElementById("progress");
    const timeEl = document.getElementById("time");

    let index = Math.floor(Math.random() * TRACKS.length);
    let isPlaying = false;

    function loadTrack(i) {
        const track = TRACKS[i];

        audio.src = track.src;
        titleEl.textContent = track.title;
        artistEl.textContent = track.artist;
        coverEl.src = track.cover;

        progressEl.style.width = "0%";
        timeEl.textContent = "0:00";
        playIcon.textContent = "▶";
        isPlaying = false;
    }

    function togglePlay() {
        if (!audio.src) loadTrack(index);

        if (audio.paused) {
            audio.play();
            playIcon.textContent = "⏸";
            isPlaying = true;
        } else {
            audio.pause();
            playIcon.textContent = "▶";
            isPlaying = false;
        }
    }

    function nextTrack() {
        index = (index + 1) % TRACKS.length;
        loadTrack(index);
        audio.play();
        playIcon.textContent = "⏸";
        isPlaying = true;
    }

    audio.addEventListener("timeupdate", () => {
        const percent = audio.duration
        ? (audio.currentTime / audio.duration) * 100
        : 0;
        progressEl.style.width = `${percent}%`;
        timeEl.textContent = formatTime(audio.currentTime);
    });

    audio.addEventListener("ended", nextTrack);

    playBtn.addEventListener("click", togglePlay);
    nextBtn.addEventListener("click", nextTrack);

    function formatTime(s) {
        const m = Math.floor(s / 60);
        const sec = Math.floor(s % 60);
        return `${m}:${sec.toString().padStart(2, "0")}`;
    }

    loadTrack(index);
</script>